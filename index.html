<html>
<head>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
</head>
<body>
  <a-scene embedded arjs="patternRatio:0.80">
    <!-- Marker Detection -->
    <a-marker type="pattern" url="qrcode.patt">
      <!-- 3D model with animation-mixer component -->
      <a-entity id="animated-object"
                gltf-model="url(https://baptistajs.github.io/bottle-animation-test/bottle-animation-new.glb)"
                position="0 0 0"
                rotation="0 90 0"
                scale="50 50 50"
                animation-mixer="clip: Animation; loop: false; clampWhenFinished: true">
      </a-entity>
    </a-marker>

    <!-- Raycaster will cast rays from the screen -->
    <a-entity camera position="0 0 0"></a-entity>
  </a-scene>

  <script>
    // Add a click/touch event listener to the whole scene
    document.querySelector('a-scene').addEventListener('click', function (evt) {
      var scene = this;
      var animatedObject = document.querySelector('#animated-object');

      // Create a raycaster and set its origin from the camera
      var camera = scene.querySelector('a-entity[camera]');
      var raycaster = new THREE.Raycaster();
      var mouse = new THREE.Vector2();

      // Get the position of the click/tap on the screen
      mouse.x = (evt.clientX / window.innerWidth) * 2 - 1;
      mouse.y = - (evt.clientY / window.innerHeight) * 2 + 1;

      // Update the raycaster based on the camera's position and the screen tap
      raycaster.setFromCamera(mouse, camera.components.camera.camera);

      // Get the 3D object for raycasting
      var intersectedObjects = raycaster.intersectObject(animatedObject.object3D, true);

      // Check if the ray hit the model
      if (intersectedObjects.length > 0) {
        console.log('Object clicked, starting animation...');
        var mixer = animatedObject.components['animation-mixer'];
        
        // Play the animation if it's not running
        if (!mixer.mixer._actions[0].isRunning()) {
          mixer.mixer._actions[0].play();
        }
      }
    });
  </script>
</body>
</html>
